[Линк към DEMO видео.](https://drive.google.com/file/d/1xV8vYAMWZk_o8Rh8UJ-sskaIchkZ8IDW/view?usp=sharing)



[Линк към SQL файла](https://github.com/AyhanHasanov/use-case-3-etl-p1/blob/main/sql/queries.sql)
## Преглед

Този SQL скрипт имплементира следното:

1.  Създава база данни и схеми за етапите на временно съхранение (staging), "почистване" на данните (трансформация) и данните в краен вид, готови за употреба.
2.  Импортира "сурови" данни за поръчки от S3 bucket
3.  Извършва валидиране на данните
4.  Обработва записите с "некачествени" данни
5.  Генерира финални таблици, готови за продукционна среда
   
## **Схеми (Schemes) и Таблици**

### 1. Stage_external схема:
-   `raw_orders`– Временна таблица, която съдържа необработените (сурови) данни, заредени от външен източник (CSV файла). Всички данни са в текстов (varchar) формат.
    

### 2. Curated схема:
-   `clean_orders` – Таблица с данни от `raw_orders`, но преобразувани в коректните типове (например дати, числа).
-   `deduplicated_orders` – Същите данни като `clean_orders`, но без дублиращи се записи (по `order_id`).
-   `td_for_review` – Съдържа записи, които трябва да бъдат прегледани ръчно, например липсващ адрес за доставка при статус "Delivered" или "Shipped".
-   `td_invalid_date` – Съдържа записи с невалидни дати (напр. 30-ти февруари), като се запазва оригиналната (невалидна) стойност на датата.
-   `td_invalid_price_or_quantity` – Записи с некоректни цени или количества (отрицателни стойности).
-   `td_suspicious_records` – Записи без `customer_id`, които се считат за подозрителни.
    

### 3. Production схема:

-   `orders` – Финалната таблица с валидни поръчки, които са преминали всички проверки и трансформации.
-   `td_for_review` – Същата таблица като в `curated`, но запазена в продукционната среда за допълнителна проверка.
    

> Таблиците `raw_orders`, `clean_orders` и `deduplicated_orders` са **temporary**, защото са необходими само по време на обработката на данните - след дадената сесия автомотично се изтриват.

> Таблиците `td_for_review`, `td_invalid_date`, `td_invalid_price_or_quantity` и `td_suspicious_records` са **transient**, тъй като съхраняват временни, но потенциално важни данни, които трябва да бъдат прегледани, преди да бъдат окончателно обработени или изтрити.

## Поток на данните

-   **Извличане (Extract)**: Суровите данни се извличат от  `s3://fakecompanydata/`  в таблицата  `stage_external.raw_orders`.
    
-   **Трансформация (Transform)**: Данните се почистват (конвертиране на типове, премахване на дублиращи се записи...), валидират и коригират (например преизчисляване на total_amount). Този етап се случва в различни таблици в curated схемата.
    
-   **Зареждане (Load)**: Обработените данни се зареждат в  `production.orders` и  `production.td_for_review`.
    

### 1. Настройка на базата данни
```sql
DROP DATABASE IF EXISTS ecommerce_db;
CREATE DATABASE IF NOT EXISTS ecommerce_db;
USE ecommerce_db;
```
-   Създава нова "ecommerce" база данни
    

### 2. Настройка на staging схемата
```sql 
CREATE SCHEMA IF NOT EXISTS stage_external;

CREATE OR REPLACE STAGE stage_external.ec_stage
URL = 's3://fakecompanydata/'
FILE_FORMAT = (TYPE = CSV);

CREATE TEMPORARY TABLE stage_external.raw_orders;
COPY INTO stage_external.raw_orders
FROM @stage_external.ec_stage
FILE_FORMAT = (
    TYPE = CSV,
    FIELD_DELIMITER = ','
    FIELD_OPTIONALLY_ENCLOSED_BY='"'
    PARSE_HEADER = TRUE
    )
MATCH_BY_COLUMN_NAME = 'CASE_INSENSITIVE';
```
-   Настройва EXTERNAL STAGE, сочещ към S3 bucket
-   Създава временна таблица за суровите CSV данни
-   Зарежда данни от S3 в таблицата `raw_orders`
    

### 3. Почистване на данни (схема Curated)

```sql 
CREATE SCHEMA IF NOT EXISTS curated;
CREATE TEMPORARY TABLE curated.clean_orders AS SELECT...;
```
-   Конвертира типове данни (дати, числа)
-   Обработва NULL стойности със стойности по подразбиране
-   Преизчислява total_amount при липсваща стойност
    

### 4. Премахване на дублирани записи
```sql 
CREATE TEMPORARY TABLE curated.deduplicated_orders AS...;
```
-   Премахва дублиращи се поръчки, запазвайки само най-новите по order_date

### 5. Обработка на качеството на данните
Създава няколко временни таблици за обработка на различни проблеми с данните:

1.  **Подозрителни записи**  - Поръчки с липсващ customer_id
2.  **Невалиден формат на дата**  - Поръчки с неразбираеми дати
3.  **Невалидна цена/количество**  - Отрицателни стойности
4.  **Записи за преглед**  - Доставени/Изпратени поръчки с липсващ shipping address
    

### 6. Корекции на данните
```sql
UPDATE curated.deduplicated_orders...;
```
-   Коригира невалидни отстъпки (ограничава ги между 0-0.5)
-   Задава стойност по подразбиране 'Unknown' за липсващи методи на плащане
-   Преизчислява total_amount въз основа на quantity, price и discount
    

### 7. Зареждане в продукционна среда
```sql
CREATE SCHEMA IF NOT EXISTS production;
CREATE TABLE IF NOT EXISTS orders...;
CREATE TRANSIENT TABLE IF NOT EXISTS td_for_review...;
```
-   Създава финални продукционни таблици
-   Зарежда почистените данни в production.orders
-   Зарежда записите, нуждаещи се от преглед, в production.td_for_review
    

## Основни трансформации на данните

1.  **Извличане и конвертиране на данните от CSV файла**: 
	- Всички полета първоначално се зареждат като VARCHAR (низ) и след това се конвертират към правилните типове (дата, числа и т.н.)
    
3.  **Стойности по подразбиране**:
    -   Невалидни дати се задават на '1000-01-01'
    -   Невалидни количества и цени се задават на -1
    -   Липсващи отстъпки се задават на 0
        
4.  **Валидиране на данни**:
    -   Премахване на записи с отрицателни цени и количества
    -   Маркиране на поръчки с невалидна комбинация статус/адрес за доставка
        
5.  **Бизнес правила**:
    -   Отстъпките са ограничени от 0% (0.0) до 50% (0.5)        
    -   Липсващи методи на плащане се маркират като 'Unknown'
    -   Проблемни поръчки се преместват в таблици за допълнително преглеждане
        

## Изходни таблици
1.  **production.orders**  - Почистени, валидирани данни за поръчки, готови за анализ
2.  **production.td_for_review**  - Записи, изискващи ръчен преглед и корекция
